<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHX Home Buying Analysis Dashboard - December 2025</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #1a1a1a;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .loading {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            font-size: 1.2em;
            color: #667eea;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        /* Header */
        .header {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header .subtitle {
            font-size: 1.2em;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        .stats-bar {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 30px;
        }

        .stat-box {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            color: white;
            text-align: center;
        }

        .stat-box .label {
            font-size: 0.85em;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-box .value {
            font-size: 2em;
            font-weight: bold;
            margin-top: 5px;
        }

        /* Executive Summary */
        .exec-summary {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .exec-summary h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .picks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .pick-card {
            padding: 20px;
            border-radius: 8px;
            border-left: 5px solid;
        }

        .pick-card.top-pick {
            background: #d4edda;
            border-color: #28a745;
        }

        .pick-card.runner-up {
            background: #d1ecf1;
            border-color: #17a2b8;
        }

        .pick-card.budget {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .pick-card.insight {
            background: #f8d7da;
            border-color: #dc3545;
            grid-column: 1 / -1;
        }

        .pick-card .pick-label {
            font-weight: bold;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .pick-card .pick-address {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .pick-card .pick-details {
            font-size: 0.95em;
            color: #555;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .card-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .card-header h3 {
            font-size: 1.3em;
            margin-bottom: 5px;
        }

        .card-header .description {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .card-preview {
            padding: 20px;
            height: 250px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            position: relative;
        }

        .card-preview iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 4px;
        }

        .card-preview img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 4px;
        }

        .card-preview .icon {
            font-size: 4em;
            color: #667eea;
        }

        .card-footer {
            padding: 20px;
            text-align: center;
        }

        .btn {
            display: inline-block;
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        /* Tables */
        .tables-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .tables-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .tables-section h3 {
            color: #2c3e50;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge.pass {
            background: #d4edda;
            color: #155724;
        }

        .badge.fail {
            background: #f8d7da;
            color: #721c24;
        }

        .badge.unicorn {
            background: #e7d4f7;
            color: #6f42c1;
        }

        .badge.contender {
            background: #cfe2ff;
            color: #084298;
        }

        /* Methodology */
        .methodology {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .methodology h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .methodology h2::after {
            content: '‚ñº';
            font-size: 0.7em;
        }

        .methodology h2.collapsed::after {
            content: '‚ñ∂';
        }

        .methodology-content {
            margin-top: 20px;
        }

        .methodology-content.hidden {
            display: none;
        }

        .methodology-section {
            margin-bottom: 20px;
        }

        .methodology-section h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .methodology-section ul {
            margin-left: 20px;
        }

        .methodology-section li {
            margin-bottom: 5px;
        }

        /* Footer */
        .footer {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .footer p {
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .footer .links {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .footer .links a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .footer .links a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .picks-grid {
                grid-template-columns: 1fr;
            }

            .stat-box {
                min-width: 120px;
            }

            .stat-box .value {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" class="loading">Loading property data...</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="content" style="display: none;">
            <!-- Header -->
            <div class="header">
                <h1>PHX Home Buying Analysis Dashboard</h1>
                <div class="subtitle">December 2025 - Complete Property Analysis</div>
                <div class="stats-bar">
                    <div class="stat-box">
                        <div class="label">Total Properties</div>
                        <div class="value" id="stat-total">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Pass Criteria</div>
                        <div class="value" id="stat-pass">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Average Score</div>
                        <div class="value" id="stat-avg">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Top Score</div>
                        <div class="value" id="stat-top">-</div>
                    </div>
                </div>
            </div>

            <!-- Executive Summary -->
            <div class="exec-summary">
                <h2>Executive Summary</h2>
                <div class="picks-grid" id="picks-grid">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Dashboard Grid -->
            <div class="dashboard-grid">
                <!-- Card 1: Golden Zone Map -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>Golden Zone Map</h3>
                        <div class="description">Interactive property location map</div>
                    </div>
                    <div class="card-preview">
                        <iframe src="golden_zone_map.html" loading="lazy"></iframe>
                    </div>
                    <div class="card-footer">
                        <a href="golden_zone_map.html" class="btn" target="_blank">View Full Map</a>
                    </div>
                </div>

                <!-- Card 2: Value Spotter -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>Value Spotter</h3>
                        <div class="description">Score vs. price scatter analysis</div>
                    </div>
                    <div class="card-preview">
                        <iframe src="value_spotter.html" loading="lazy"></iframe>
                    </div>
                    <div class="card-footer">
                        <a href="value_spotter.html" class="btn" target="_blank">Analyze Values</a>
                    </div>
                </div>

                <!-- Card 3: Radar Comparison -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>Radar Comparison</h3>
                        <div class="description">Top 3 properties feature comparison</div>
                    </div>
                    <div class="card-preview">
                        <img src="radar_comparison.png" alt="Radar Comparison" loading="lazy">
                    </div>
                    <div class="card-footer">
                        <a href="radar_comparison.html" class="btn" target="_blank">Compare Top 3</a>
                    </div>
                </div>

                <!-- Card 4: Deal Sheets -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>Deal Sheets</h3>
                        <div class="description" id="deal-sheets-count">Traffic light reports for all properties</div>
                    </div>
                    <div class="card-preview">
                        <div class="icon">üìã</div>
                    </div>
                    <div class="card-footer">
                        <a href="../deal_sheets/index.html" class="btn" target="_blank">Browse All</a>
                    </div>
                </div>

                <!-- Card 5: Renovation Gap -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>Renovation Gap Report</h3>
                        <div class="description">True cost calculator with repairs</div>
                    </div>
                    <div class="card-preview">
                        <div class="icon">üíµ</div>
                    </div>
                    <div class="card-footer">
                        <a href="renovation_gap_report.html" class="btn" target="_blank">Calculate True Cost</a>
                    </div>
                </div>

                <!-- Card 6: Risk Report -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>Risk Report</h3>
                        <div class="description">Due diligence risk assessment</div>
                    </div>
                    <div class="card-preview">
                        <div class="icon">‚ö†Ô∏è</div>
                    </div>
                    <div class="card-footer">
                        <a href="risk_report.html" class="btn" target="_blank">View Risk Assessment</a>
                    </div>
                </div>
            </div>

            <!-- Quick Reference Tables -->
            <div class="tables-section">
                <h2>Quick Reference</h2>

                <h3>Top Properties (PASS Only)</h3>
                <table id="top-properties-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)">Rank</th>
                            <th onclick="sortTable(1)">Address</th>
                            <th onclick="sortTable(2)">Price</th>
                            <th onclick="sortTable(3)">Score</th>
                            <th onclick="sortTable(4)">Beds/Baths</th>
                            <th onclick="sortTable(5)">Tier</th>
                        </tr>
                    </thead>
                    <tbody id="top-properties-body">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>

                <h3>All Properties</h3>
                <table id="all-properties-table">
                    <thead>
                        <tr>
                            <th onclick="sortAllTable(0)">Rank</th>
                            <th onclick="sortAllTable(1)">Address</th>
                            <th onclick="sortAllTable(2)">City</th>
                            <th onclick="sortAllTable(3)">Price</th>
                            <th onclick="sortAllTable(4)">Score</th>
                            <th onclick="sortAllTable(5)">Beds</th>
                            <th onclick="sortAllTable(6)">Baths</th>
                            <th onclick="sortAllTable(7)">Tier</th>
                            <th onclick="sortAllTable(8)">Status</th>
                        </tr>
                    </thead>
                    <tbody id="all-properties-body">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>

                <h3>Tier Breakdown</h3>
                <table id="tier-breakdown-table">
                    <thead>
                        <tr>
                            <th>Tier</th>
                            <th>Score Range</th>
                            <th>Count</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody id="tier-breakdown-body">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Methodology -->
            <div class="methodology">
                <h2 id="methodology-toggle">Methodology Notes</h2>
                <div class="methodology-content" id="methodology-content">
                    <div class="methodology-section">
                        <h3>Scoring System (Max 600 points)</h3>
                        <ul>
                            <li><strong>Section A: Location & Environment (230 pts)</strong> - School district rating, quietness/noise, safety, supermarket proximity, parks & walkability, sun orientation</li>
                            <li><strong>Section B: Lot & Systems (180 pts)</strong> - Roof condition/age, backyard utility, plumbing/electrical, pool condition, cost efficiency</li>
                            <li><strong>Section C: Interior & Features (190 pts)</strong> - Kitchen layout, master suite, natural light, high ceilings, fireplace, laundry area, aesthetics</li>
                        </ul>
                    </div>

                    <div class="methodology-section">
                        <h3>Kill Switch Criteria (Weighted Threshold System)</h3>
                        <ul>
                            <li><strong>HARD Criteria (Instant Fail):</strong> NO HOA fees, Min 4 beds, Min 2 baths</li>
                            <li><strong>SOFT Criteria (Severity Score):</strong> City sewer (2.5), No new builds (2.0), Min 2-car garage (1.5), Lot size 7,000-15,000 sqft (1.0)</li>
                            <li><strong>Verdict:</strong> FAIL if severity >= 3.0 | WARNING if 1.5-3.0 | PASS if < 1.5</li>
                        </ul>
                    </div>

                    <div class="methodology-section">
                        <h3>Tier Classification</h3>
                        <ul>
                            <li><strong>Unicorn:</strong> >480 points</li>
                            <li><strong>Contender:</strong> 360-480 points</li>
                            <li><strong>Pass:</strong> <360 points</li>
                        </ul>
                    </div>

                    <div class="methodology-section">
                        <h3>Data Sources</h3>
                        <ul>
                            <li><strong>Maricopa County Assessor:</strong> Lot size, year built, garage spaces, sewer type, property tax</li>
                            <li><strong>GreatSchools.org:</strong> School district ratings (1-10 scale)</li>
                            <li><strong>Google Maps:</strong> Commute times, distance to groceries/highways</li>
                            <li><strong>Zillow/Redfin:</strong> Price, beds, baths, sqft, HOA fees, photos</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="footer">
                <p>Generated on <span id="footer-date"></span> by PHX Home Analyzer</p>
                <div class="links">
                    <a href="../../data/phx_homes_ranked.csv" download>Download Ranked Data (CSV)</a>
                    <a href="../../data/enrichment_data.json" download>Download Enrichment Data (JSON)</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CSV parser that handles quoted fields with commas
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = parseCSVLine(lines[0]);
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = parseCSVLine(lines[i]);
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header.trim()] = values[index] || '';
                });
                data.push(obj);
            }

            return data;
        }

        // Parse a single CSV line, handling quoted fields
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // Escaped quote
                        current += '"';
                        i++;
                    } else {
                        // Toggle quote state
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // End of field
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }

            // Add last field
            result.push(current.trim());
            return result;
        }

        // Format currency
        function formatCurrency(value) {
            if (!value) return '-';
            // Remove any $ and commas first if it's a string
            const numValue = typeof value === 'string' ? parseFloat(value.replace(/[$,]/g, '')) : parseFloat(value);
            if (isNaN(numValue)) return '-';
            return '$' + numValue.toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }

        // Format number
        function formatNumber(value, decimals = 1) {
            return parseFloat(value).toFixed(decimals);
        }

        // Get tier badge HTML
        function getTierBadge(tier) {
            const tierLower = tier.toLowerCase();
            if (tierLower === 'unicorn') return '<span class="badge unicorn">Unicorn</span>';
            if (tierLower === 'contender') return '<span class="badge contender">Contender</span>';
            if (tierLower === 'pass') return '<span class="badge pass">Pass</span>';
            if (tierLower === 'failed') return '<span class="badge fail">Failed</span>';
            return '<span class="badge">' + tier + '</span>';
        }

        // Sort table function
        let sortDirections = {};
        function sortTable(columnIndex) {
            const table = document.getElementById('top-properties-table');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            const direction = sortDirections[columnIndex] || 'asc';
            sortDirections[columnIndex] = direction === 'asc' ? 'desc' : 'asc';

            rows.sort((a, b) => {
                const aVal = a.cells[columnIndex].textContent.trim();
                const bVal = b.cells[columnIndex].textContent.trim();

                const aNum = parseFloat(aVal.replace(/[$,]/g, ''));
                const bNum = parseFloat(bVal.replace(/[$,]/g, ''));

                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return direction === 'asc' ? aNum - bNum : bNum - aNum;
                }

                return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
            });

            rows.forEach(row => tbody.appendChild(row));
        }

        let sortAllDirections = {};
        function sortAllTable(columnIndex) {
            const table = document.getElementById('all-properties-table');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            const direction = sortAllDirections[columnIndex] || 'asc';
            sortAllDirections[columnIndex] = direction === 'asc' ? 'desc' : 'asc';

            rows.sort((a, b) => {
                const aVal = a.cells[columnIndex].textContent.trim();
                const bVal = b.cells[columnIndex].textContent.trim();

                const aNum = parseFloat(aVal.replace(/[$,]/g, ''));
                const bNum = parseFloat(bVal.replace(/[$,]/g, ''));

                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return direction === 'asc' ? aNum - bNum : bNum - aNum;
                }

                return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
            });

            rows.forEach(row => tbody.appendChild(row));
        }

        // Load and process data
        async function loadData() {
            try {
                // Load CSV data
                const csvResponse = await fetch('../../data/phx_homes_ranked.csv');
                if (!csvResponse.ok) throw new Error('Failed to load CSV data');
                const csvText = await csvResponse.text();
                const properties = parseCSV(csvText);

                // Calculate statistics
                const totalProperties = properties.length;
                const passedProperties = properties.filter(p => p.kill_switch_passed === 'true' || p.kill_switch_passed === true);
                const failedProperties = properties.filter(p => p.kill_switch_passed === 'false' || p.kill_switch_passed === false);

                const passedScores = passedProperties.map(p => parseFloat(p.total_score)).filter(s => !isNaN(s));
                const avgScore = passedScores.length > 0
                    ? (passedScores.reduce((a, b) => a + b, 0) / passedScores.length)
                    : 0;
                const topScore = passedScores.length > 0 ? Math.max(...passedScores) : 0;

                // Update stats
                document.getElementById('stat-total').textContent = totalProperties;
                document.getElementById('stat-pass').textContent = passedProperties.length;
                document.getElementById('stat-avg').textContent = formatNumber(avgScore, 1);
                document.getElementById('stat-top').textContent = formatNumber(topScore, 0);

                // Update deal sheets count
                document.getElementById('deal-sheets-count').textContent =
                    `Traffic light reports for all ${totalProperties} properties`;

                // Sort passed properties by score and get top 3
                passedProperties.sort((a, b) => parseFloat(b.total_score) - parseFloat(a.total_score));
                const top3 = passedProperties.slice(0, 3);

                // Build executive summary
                const picksGrid = document.getElementById('picks-grid');
                let picksHTML = '';

                if (top3.length >= 1) {
                    const prop = top3[0];
                    picksHTML += `
                        <div class="pick-card top-pick">
                            <div class="pick-label">üèÜ TOP PICK</div>
                            <div class="pick-address">${prop.full_address.split(',')[0]}, ${prop.city}</div>
                            <div class="pick-details">
                                <strong>${formatCurrency(prop.price)}</strong> | ${formatNumber(prop.total_score, 0)} points | ${prop.beds} bed, ${prop.baths} bath<br>
                                <em>Highest-scoring property with best value</em>
                            </div>
                        </div>
                    `;
                }

                if (top3.length >= 2) {
                    const prop = top3[1];
                    picksHTML += `
                        <div class="pick-card runner-up">
                            <div class="pick-label">ü•à RUNNER UP</div>
                            <div class="pick-address">${prop.full_address.split(',')[0]}, ${prop.city}</div>
                            <div class="pick-details">
                                <strong>${formatCurrency(prop.price)}</strong> | ${formatNumber(prop.total_score, 0)} points | ${prop.beds} bed, ${prop.baths} bath<br>
                                <em>Strong score with excellent location</em>
                            </div>
                        </div>
                    `;
                }

                if (top3.length >= 3) {
                    const prop = top3[2];
                    picksHTML += `
                        <div class="pick-card budget">
                            <div class="pick-label">üíé VALUE PICK</div>
                            <div class="pick-address">${prop.full_address.split(',')[0]}, ${prop.city}</div>
                            <div class="pick-details">
                                <strong>${formatCurrency(prop.price)}</strong> | ${formatNumber(prop.total_score, 1)} points | ${prop.beds} bed, ${prop.baths} bath<br>
                                <em>Excellent score-to-price ratio</em>
                            </div>
                        </div>
                    `;
                }

                // Add key insight
                const passRate = ((passedProperties.length / totalProperties) * 100).toFixed(0);
                const scoreRange = passedScores.length > 0
                    ? `${Math.min(...passedScores).toFixed(0)}-${Math.max(...passedScores).toFixed(0)}`
                    : '0-0';

                picksHTML += `
                    <div class="pick-card insight">
                        <div class="pick-label">üí° KEY INSIGHT</div>
                        <div class="pick-details">
                            <strong>${passedProperties.length} of ${totalProperties} properties passed kill-switch criteria (${passRate}% pass rate)</strong>.
                            Passing properties average ${formatNumber(avgScore, 1)} points with top score of ${formatNumber(topScore, 0)}.
                            ${failedProperties.length} properties failed due to kill-switch violations (HOA, lot size, or other structural criteria).
                            Score range: ${scoreRange} points.
                        </div>
                    </div>
                `;

                picksGrid.innerHTML = picksHTML;

                // Build top properties table (top 10 passing only)
                const topPropertiesBody = document.getElementById('top-properties-body');
                let topPropertiesHTML = '';
                passedProperties.slice(0, 10).forEach((prop, index) => {
                    const rank = index + 1;
                    topPropertiesHTML += `
                        <tr>
                            <td>${rank}</td>
                            <td>${prop.full_address}</td>
                            <td>${formatCurrency(prop.price)}</td>
                            <td>${formatNumber(prop.total_score, 1)}</td>
                            <td>${prop.beds} / ${prop.baths}</td>
                            <td>${getTierBadge(prop.tier)}</td>
                        </tr>
                    `;
                });
                topPropertiesBody.innerHTML = topPropertiesHTML;

                // Build all properties table - sort all properties by score
                const allPropertiesSorted = [...properties].sort((a, b) => parseFloat(b.total_score) - parseFloat(a.total_score));
                const allPropertiesBody = document.getElementById('all-properties-body');
                let allPropertiesHTML = '';
                allPropertiesSorted.forEach((prop, index) => {
                    const rank = index + 1;
                    const statusBadge = (prop.kill_switch_passed === 'true' || prop.kill_switch_passed === true)
                        ? '<span class="badge pass">PASS</span>'
                        : '<span class="badge fail">FAIL</span>';

                    allPropertiesHTML += `
                        <tr>
                            <td>${rank}</td>
                            <td>${prop.full_address.split(',')[0]}</td>
                            <td>${prop.city}</td>
                            <td>${formatCurrency(prop.price)}</td>
                            <td>${formatNumber(prop.total_score, 1)}</td>
                            <td>${prop.beds}</td>
                            <td>${prop.baths}</td>
                            <td>${getTierBadge(prop.tier)}</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
                });
                allPropertiesBody.innerHTML = allPropertiesHTML;

                // Build tier breakdown - tier values are lowercase in CSV
                const tierCounts = {
                    'Unicorn': properties.filter(p => p.tier && p.tier.toLowerCase() === 'unicorn' && (p.kill_switch_passed === 'true' || p.kill_switch_passed === true)).length,
                    'Contender': properties.filter(p => p.tier && p.tier.toLowerCase() === 'contender' && (p.kill_switch_passed === 'true' || p.kill_switch_passed === true)).length,
                    'Pass': properties.filter(p => p.tier && p.tier.toLowerCase() === 'pass' && (p.kill_switch_passed === 'true' || p.kill_switch_passed === true)).length,
                    'Failed': properties.filter(p => p.kill_switch_passed === 'false' || p.kill_switch_passed === false).length
                };

                const tierBreakdownBody = document.getElementById('tier-breakdown-body');
                let tierBreakdownHTML = `
                    <tr>
                        <td><span class="badge unicorn">Unicorn</span></td>
                        <td>>480 points</td>
                        <td>${tierCounts.Unicorn}</td>
                        <td>${((tierCounts.Unicorn / totalProperties) * 100).toFixed(1)}%</td>
                    </tr>
                    <tr>
                        <td><span class="badge contender">Contender</span></td>
                        <td>360-480 points</td>
                        <td>${tierCounts.Contender}</td>
                        <td>${((tierCounts.Contender / totalProperties) * 100).toFixed(1)}%</td>
                    </tr>
                    <tr>
                        <td><span class="badge pass">Pass</span></td>
                        <td><360 points</td>
                        <td>${tierCounts.Pass}</td>
                        <td>${((tierCounts.Pass / totalProperties) * 100).toFixed(1)}%</td>
                    </tr>
                    <tr>
                        <td><span class="badge fail">Failed</span></td>
                        <td>Kill-switch failures</td>
                        <td>${tierCounts.Failed}</td>
                        <td>${((tierCounts.Failed / totalProperties) * 100).toFixed(1)}%</td>
                    </tr>
                `;
                tierBreakdownBody.innerHTML = tierBreakdownHTML;

                // Update footer date
                document.getElementById('footer-date').textContent = new Date().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                // Hide loading, show content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent =
                    'Error loading property data: ' + error.message + '. Please ensure data files are available at ../../data/';
            }
        }

        // Toggle methodology section
        document.addEventListener('DOMContentLoaded', function() {
            loadData();

            document.getElementById('methodology-toggle').addEventListener('click', function() {
                const content = document.getElementById('methodology-content');
                const toggle = document.getElementById('methodology-toggle');

                if (content.classList.contains('hidden')) {
                    content.classList.remove('hidden');
                    toggle.classList.remove('collapsed');
                } else {
                    content.classList.add('hidden');
                    toggle.classList.add('collapsed');
                }
            });

            // Initialize methodology as collapsed
            document.getElementById('methodology-content').classList.add('hidden');
            document.getElementById('methodology-toggle').classList.add('collapsed');
        });
    </script>
</body>
</html>
