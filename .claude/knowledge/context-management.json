{
  "$schema": "context-management-schema-v1",
  "version": "1.0.0",
  "last_updated": "2025-12-02",

  "discovery_protocol": {
    "description": "Auto-discover and maintain CLAUDE.md files in directories",
    "triggers": [
      "on_read_file_in_directory",
      "on_navigate_to_directory",
      "on_create_file_in_directory"
    ],
    "action": "check_for_claude_md",
    "if_missing": {
      "action": "create_placeholder",
      "template": ".claude/templates/CLAUDE.md.template",
      "flags": ["UPDATE_ME"]
    },
    "excluded_directories": [
      "node_modules", ".git", "__pycache__", ".venv",
      "venv", ".pytest_cache", "data/property_images/processed"
    ]
  },

  "staleness_protocol": {
    "check_on": ["session_start", "before_agent_spawn", "before_commit"],
    "thresholds": {
      "default_hours": 24,
      "warning_hours": 12,
      "critical_files_hours": 12
    },
    "critical_files": [
      "data/work_items.json",
      "data/enrichment_data.json"
    ],
    "stale_actions": {
      "default": "flag_for_review",
      "critical": "warn_user"
    }
  },

  "update_triggers": [
    {
      "event": "UPDATE_ME_flag_detected",
      "action": "prompt_to_update",
      "priority": "high"
    },
    {
      "event": "files_created_in_directory",
      "action": "update_contents_section",
      "priority": "medium"
    },
    {
      "event": "agent_completed_work",
      "action": "update_pending_tasks_and_learnings",
      "priority": "high"
    },
    {
      "event": "error_discovered",
      "action": "add_to_key_learnings",
      "priority": "high"
    },
    {
      "event": "session_wrapping_up",
      "action": "update_pending_tasks",
      "priority": "medium"
    }
  ],

  "state_files": [
    {
      "path": "data/work_items.json",
      "purpose": "Pipeline progress tracking",
      "check_on": ["session_start", "before_agent_spawn"],
      "staleness_field": "session.started_at",
      "critical": true
    },
    {
      "path": "data/enrichment_data.json",
      "purpose": "Property data store",
      "check_on": ["before_property_operations"],
      "critical": true
    },
    {
      "path": "data/property_images/metadata/extraction_state.json",
      "purpose": "Image extraction state",
      "check_on": ["before_image_operations"],
      "critical": false
    },
    {
      "path": "data/property_images/metadata/address_folder_lookup.json",
      "purpose": "Address to image folder mapping",
      "check_on": ["before_image_assessment"],
      "critical": false
    }
  ],

  "agent_handoff": {
    "required_reading": [
      ".claude/AGENT_BRIEFING.md",
      "data/work_items.json"
    ],
    "on_spawn": {
      "main_provides": ["task", "target_address", "current_phase", "constraints"],
      "agent_reads": ["AGENT_BRIEFING.md", "work_items.json", "relevant skill files"]
    },
    "on_completion": {
      "agent_updates": ["work_items.json", "enrichment_data.json", "directory CLAUDE.md"],
      "agent_reports": ["status", "data_collected", "errors", "files_updated"]
    }
  },

  "spawn_validation_protocol": {
    "description": "Mandatory pre-spawn validation before agent Task dispatch",
    "applies_to": ["phase2_images"],
    "script": "scripts/validate_phase_prerequisites.py",
    "workflow": [
      "1. Run validation: python scripts/validate_phase_prerequisites.py --address \"ADDRESS\" --phase PHASE --json",
      "2. Parse JSON result for can_spawn boolean",
      "3. If can_spawn=true: Include context in agent prompt (image_folder, image_count, property_data)",
      "4. If can_spawn=false: Do NOT spawn - return structured error to user/orchestrator"
    ],
    "context_to_include_in_prompt": ["image_folder", "image_count", "year_built", "orientation", "phase_status"],
    "skip_validation_phases": ["phase0_county", "phase1_listing", "phase1_map"]
  },

  "failure_response_protocols": {
    "description": "Structured error handling when validation or agents fail",
    "prerequisite_not_met": {
      "action": "return_structured_error",
      "update_work_items": true,
      "response_template": {
        "status": "blocked",
        "phase": "PHASE_NAME",
        "address": "ADDRESS",
        "reason": "FROM_VALIDATION_RESULT",
        "remediation": ["Complete Phase 1 listing first", "Run extract_images.py", "Check work_items.json"]
      }
    },
    "data_inconsistency": {
      "action": "attempt_repair_then_retry",
      "repair_command": "python scripts/validate_phase_prerequisites.py --reconcile --address \"ADDRESS\" --repair",
      "max_retries": 1,
      "on_repair_failure": "escalate_to_user"
    },
    "agent_timeout": {
      "action": "update_work_items_status",
      "set_status": "failed",
      "preserve_partial_data": true
    }
  },

  "reference_format": {
    "syntax": "path:line-range",
    "style": "relative_to_project_root",
    "examples": [
      "scripts/lib/kill_switch.py:45-89",
      "src/phx_home_analysis/config/constants.py:12-67"
    ],
    "markdown": "- [Description]: `path:lines`",
    "grep_command": "rg -n \"pattern\" path"
  },

  "claude_md_sections": {
    "required": ["purpose", "contents"],
    "recommended": ["pending_tasks", "key_learnings", "references"],
    "optional": ["dependencies"]
  },

  "directory_contexts": {
    "scripts/": {
      "purpose": "Main analysis scripts and utilities",
      "staleness_hours": 48,
      "key_files": ["phx_home_analyzer.py", "extract_images.py", "extract_county_data.py", "validate_phase_prerequisites.py"]
    },
    "data/": {
      "purpose": "Property data and state files",
      "staleness_hours": 12,
      "critical": true,
      "key_files": ["enrichment_data.json", "work_items.json", "phx_homes.csv"]
    },
    "src/phx_home_analysis/": {
      "purpose": "Core analysis library",
      "staleness_hours": 72,
      "key_subdirs": ["config/", "domain/", "services/", "validation/"]
    },
    ".claude/": {
      "purpose": "Claude Code configuration and agents",
      "staleness_hours": 168,
      "key_subdirs": ["agents/", "skills/", "commands/", "knowledge/"]
    },
    "tests/": {
      "purpose": "Test infrastructure and fixtures",
      "staleness_hours": 72,
      "key_files": ["conftest.py"],
      "key_subdirs": ["unit/", "integration/", "fixtures/", "benchmarks/"]
    },
    "docs/": {
      "purpose": "Technical documentation and guides",
      "staleness_hours": 168,
      "key_subdirs": ["architecture/", "specs/", "artifacts/", "templates/", "risk_checklists/"]
    }
  },

  "session_checklist": {
    "on_start": [
      "Read .claude/AGENT_BRIEFING.md for quick orientation",
      "Check data/work_items.json for current progress",
      "Check for stale CLAUDE.md files (UPDATE_ME flags)"
    ],
    "on_directory_enter": [
      "Check for CLAUDE.md in directory",
      "If missing, create from template with UPDATE_ME flag",
      "If present, check staleness"
    ],
    "on_work_complete": [
      "Update relevant CLAUDE.md pending_tasks",
      "Add key_learnings if discoveries made",
      "Update work_items.json phase status"
    ],
    "on_error": [
      "Add to key_learnings in relevant CLAUDE.md",
      "Note workaround if found"
    ]
  },

  "validation_rules": {
    "required_project_files": [
      "CLAUDE.md",
      ".claude/AGENT_BRIEFING.md",
      "data/work_items.json",
      "data/enrichment_data.json",
      "scripts/CLAUDE.md",
      "src/phx_home_analysis/CLAUDE.md",
      "data/CLAUDE.md",
      "tests/CLAUDE.md",
      "docs/CLAUDE.md"
    ],
    "required_directories": [
      "scripts/",
      "src/phx_home_analysis/",
      "data/",
      ".claude/",
      "tests/",
      "docs/"
    ]
  },

  "file_organization_rules": {
    "description": "File placement validation and enforcement (Protocol 9)",
    "root_allowed_files": [
      "CLAUDE.md",
      "README.md",
      "pyproject.toml",
      "uv.lock",
      ".gitignore",
      ".env",
      ".mcp.json",
      ".pre-commit-config.yaml",
      ".python-version",
      ".coverage"
    ],
    "placement_matrix": {
      "*.py": "scripts/ or tests/ or src/",
      "*_SUMMARY.md": "docs/artifacts/",
      "*_REPORT.md": "docs/artifacts/",
      "test_*.py": "tests/",
      "*.json": "data/ or config/",
      "*.csv": "data/",
      "*.html": "reports/ or docs/templates/"
    },
    "enforcement": {
      "on_file_create": "validate_placement",
      "on_session_start": "check_root_for_violations",
      "on_commit": "verify_no_root_artifacts"
    },
    "violation_response": {
      "action": "warn_and_suggest_move",
      "update_trash_files_md": true
    }
  },

  "auto_claude_md_protocol": {
    "description": "Auto-create CLAUDE.md in directories without one",
    "triggers": [
      "file_created_in_directory_without_claude_md",
      "directory_visited_without_claude_md"
    ],
    "template_path": ".claude/templates/CLAUDE.md.template",
    "placeholder_flags": ["UPDATE_ME"],
    "excluded_directories": [
      "node_modules",
      ".git",
      "__pycache__",
      ".venv",
      "venv",
      ".pytest_cache",
      ".mypy_cache",
      ".ruff_cache",
      "data/property_images/processed",
      ".playwright-mcp"
    ]
  }
}
