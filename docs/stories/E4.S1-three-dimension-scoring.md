# Story E4.S1: Three-Dimension Score Calculation

Status: done

## Story

As a system user,
I want property scores calculated across three dimensions,
So that I can see balanced quality assessment.

## Acceptance Criteria

1. [x] Each dimension (A/B/C) can be calculated independently
   - `PropertyScorer.score_location(property)` returns Location score
   - `PropertyScorer.score_systems(property)` returns Systems score
   - `PropertyScorer.score_interior(property)` returns Interior score

2. [x] `PropertyScorer` returns dimension-level breakdowns
   - `ScoreBreakdown.location_total` calculated correctly (250 pts max)
   - `ScoreBreakdown.systems_total` calculated correctly (175 pts max)
   - `ScoreBreakdown.interior_total` calculated correctly (180 pts max)
   - Total: 605 pts max (confirmed by constants.py assertion)

3. [x] Output includes per-dimension scores (not just total)
   - Deal sheet displays section subtotals
   - JSON output contains `location_total`, `systems_total`, `interior_total`
   - Console reporter shows dimension breakdown

4. [x] Dimension percentages calculated correctly
   - `ScoreBreakdown.location_percentage` = location_total / 250 * 100
   - `ScoreBreakdown.systems_percentage` = systems_total / 175 * 100
   - `ScoreBreakdown.interior_percentage` = interior_total / 180 * 100

5. [x] All existing tests pass
   - `pytest tests/unit/test_scorer.py -v` passes (97 tests)
   - `pytest tests/unit/test_domain.py -v` passes (69 tests)
   - No regression in tier classification

6. [x] New tests for dimension calculation added
   - Test independent section calculation methods (6 tests)
   - Test dimension percentage calculations (12 tests)
   - Test boundary conditions (0 pts, max pts per section)
   - Test 605-point system consistency (8 tests)

## Tasks / Subtasks

- [x] Task 1: Update ScoreBreakdown value object (AC: #2, #4)
  - [x] 1.1 Update hardcoded max values in percentage properties
    - Fixed: location_percentage uses /250 (was /230)
    - Fixed: systems_percentage uses /175 (was /180)
    - Fixed: interior_percentage uses /180 (was /190)
    - Fixed: total_percentage uses /605 (was /600)
  - [x] 1.2 Add `section_a_max`, `section_b_max`, `section_c_max` properties
  - [x] 1.3 Add `total_max` property (605)
  - [x] 1.4 Update `__str__` method to show correct maximums

- [x] Task 2: Add independent section scoring methods to PropertyScorer (AC: #1)
  - [x] 2.1 Add `score_location(property) -> float` method
  - [x] 2.2 Add `score_systems(property) -> float` method
  - [x] 2.3 Add `score_interior(property) -> float` method
  - [x] 2.4 Refactored `score()` to use list comprehensions (DRY pattern)

- [x] Task 3: Enhance score output formatting (AC: #3)
  - [x] 3.1 JSON serialization already includes dimension breakdowns via to_dict()
  - [x] 3.2 Console reporter updated to show section totals with percentages
  - [x] 3.3 Deal sheet template updated to use dynamic max values

- [x] Task 4: Write unit tests for dimension calculations (AC: #5, #6)
  - [x] 4.1 Test `score_location()` returns correct total
  - [x] 4.2 Test `score_systems()` returns correct total
  - [x] 4.3 Test `score_interior()` returns correct total
  - [x] 4.4 Test dimension percentages at boundaries (0%, 50%, 100%)
  - [x] 4.5 Test section independence (changing one doesn't affect others)

- [x] Task 5: Validate 605-point system consistency (AC: #2)
  - [x] 5.1 Verify ScoringWeights.total_possible_score == 605
  - [x] 5.2 Verify section_a_max == 250, section_b_max == 175, section_c_max == 180
  - [x] 5.3 Add assertion tests to prevent drift (8 tests)

## Dev Notes

### Existing Code Analysis

**Scoring Weights Are Already Correct (605-point system confirmed):**
- `src/phx_home_analysis/config/scoring_weights.py:253-314` defines all weights
- `section_a_max` property already exists (returns 250)
- `section_b_max` property already exists (returns 175)
- `section_c_max` property already exists (returns 180)
- `total_possible_score` property returns 605

**ScoreBreakdown Has Dimension Support, BUT Uses Stale Maximums:**
- `src/phx_home_analysis/domain/value_objects.py:139-229`
- `location_total`, `systems_total`, `interior_total` properties exist and work correctly
- **BUG FOUND:** Percentage properties use hardcoded OLD values:
  - `location_percentage` divides by 230 (should be 250)
  - `systems_percentage` divides by 180 (should be 175)
  - `interior_percentage` divides by 190 (should be 180)
  - `total_percentage` divides by 600 (should be 605)
  - `__str__` shows /230, /180, /190, /600 (all incorrect)

**PropertyScorer Already Groups by Dimension:**
- `src/phx_home_analysis/services/scoring/scorer.py:77-110`
- `score()` method correctly groups strategies into `location_scores`, `systems_scores`, `interior_scores`
- Returns `ScoreBreakdown` with all three sections
- **MISSING:** No independent section-level calculation methods

### Key Technical Constraints

1. **605-Point Calibration:**
   - Section A (Location): 250 pts = 42+30+47+23+23+25+23+22+15
   - Section B (Systems): 175 pts = 45+35+35+20+35+5
   - Section C (Interior): 180 pts = 40+35+30+25+20+20+10
   - Tier thresholds: Unicorn >= 484 (80%), Contender >= 363 (60%)

2. **Immutable Value Objects:**
   - `ScoreBreakdown` is frozen dataclass - cannot add methods that mutate state
   - All computed values must be @property decorated

3. **Backward Compatibility:**
   - Existing tests in `tests/unit/test_scorer.py` must continue passing
   - Test assertions reference old values (230, 180, 190) - must be updated

### Code Locations to Modify

| File | Lines | Change Required |
|------|-------|-----------------|
| `src/phx_home_analysis/domain/value_objects.py` | 186-220 | Fix percentage calculations to use 250/175/180/605 |
| `src/phx_home_analysis/services/scoring/scorer.py` | 77-110 | Add `score_location()`, `score_systems()`, `score_interior()` methods |
| `tests/unit/test_scorer.py` | 873-908 | Update test assertions for 250/175/180/605 |

### Testing Strategy

1. **Unit Tests (tests/unit/test_scorer.py):**
   - Add `TestDimensionCalculation` class
   - Test each section independently
   - Test combined total equals sum of sections

2. **Boundary Tests:**
   - Zero scores (all 0.0 base scores)
   - Maximum scores (all 10.0 base scores)
   - Mixed scores (varying by dimension)

3. **Regression Tests:**
   - Tier classification still works correctly
   - Existing property fixtures score as expected

### Project Structure Notes

- Alignment with unified project structure: All changes in established paths
- No new files required - enhancing existing modules
- Tests follow existing patterns in `tests/unit/test_scorer.py`

### References

- Scoring weights: `src/phx_home_analysis/config/scoring_weights.py:1-394` [Source: scoring_weights.py]
- Constants (605-point assertion): `src/phx_home_analysis/config/constants.py:482-488` [Source: constants.py]
- ScoreBreakdown: `src/phx_home_analysis/domain/value_objects.py:138-229` [Source: value_objects.py]
- PropertyScorer: `src/phx_home_analysis/services/scoring/scorer.py:22-244` [Source: scorer.py]
- Existing tests: `tests/unit/test_scorer.py:1-908` [Source: test_scorer.py]
- Epic requirements: `docs/archive/epics.md:410-425` [Source: epics.md]

## Dev Agent Record

### Context Reference

<!-- Path(s) to story context XML will be added here by context workflow -->

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

### Completion Notes List

**Implementation Summary (2025-12-04):**

1. **Bug Fix - ScoreBreakdown Percentage Calculations:**
   - Fixed hardcoded stale maximum values in percentage properties
   - Added class constants: SECTION_A_MAX=250, SECTION_B_MAX=175, SECTION_C_MAX=180, TOTAL_MAX=605
   - Added properties: section_a_max, section_b_max, section_c_max, total_max
   - Updated __str__ to use dynamic values

2. **PropertyScorer Enhancement:**
   - Added score_location(property) method - returns Location score (0-250 pts)
   - Added score_systems(property) method - returns Systems score (0-175 pts)
   - Added score_interior(property) method - returns Interior score (0-180 pts)
   - Refactored score() method to use list comprehensions for consistency

3. **Output Formatting Updates:**
   - Console reporter now shows section scores with percentages
   - HTML templates use dynamic max values from ScoreBreakdown properties
   - JSON serialization already supported via ScoringExplainer.to_dict()

4. **Test Coverage:**
   - Added 32 new tests across 4 test classes:
     - TestDimensionCalculation (6 tests) - section method testing
     - TestDimensionPercentages (12 tests) - boundary testing at 0%, 50%, 100%
     - TestScoreBreakdownMaxProperties (6 tests) - max property verification
     - TestScoringSystemConsistency (8 tests) - drift prevention assertions
   - All 166 domain+scorer tests pass
   - All 97 scorer tests pass

**Verification Commands:**
```bash
pytest tests/unit/test_scorer.py -v  # 97 passed
pytest tests/unit/test_domain.py -v  # 69 passed
mypy src/phx_home_analysis/domain/value_objects.py  # Success
ruff check src/phx_home_analysis/  # All checks passed
```

### File List

**Files Modified:**
- `src/phx_home_analysis/domain/value_objects.py` - Fixed percentage calculations, added max properties
- `src/phx_home_analysis/services/scoring/scorer.py` - Added score_location/systems/interior methods
- `src/phx_home_analysis/reporters/console_reporter.py` - Updated to show 605-point scale
- `docs/templates/components/score_breakdown.html` - Updated to use dynamic max values
- `docs/templates/components/property_card.html` - Updated to show /605 total
- `tests/unit/test_scorer.py` - Added 32 new tests for dimension calculations

**Files for Reference (Read-Only):**
- `src/phx_home_analysis/config/scoring_weights.py`
- `src/phx_home_analysis/config/constants.py`
- `src/phx_home_analysis/services/scoring/base.py`
- `src/phx_home_analysis/services/scoring/strategies/__init__.py`
